# Cloudflare Workers Configuration

## Overview

This site is deployed using [Cloudflare Workers](https://workers.cloudflare.com/), a serverless execution environment that runs on Cloudflare's global edge network. This is both cost effective (free!) and performant for our needs.

We're building with the official [@sveltejs/adapter-cloudflare](https://github.com/sveltejs/kit/tree/main/packages/adapter-cloudflare) adapter.

## Architecture

### Build Process

1. **SvelteKit Build** (`vite build`):
   - Compiles Svelte components
   - Bundles JavaScript/CSS
   - Generates worker entry point

2. **Output Structure**:

   ```
   .svelte-kit/cloudflare/
   ├── _worker.js          # Worker entry point
   ├── _app/               # JavaScript/CSS bundles
   │   ├── immutable/
   │   └── version.json
   └── [other static files]
   ```

3. **Deployment** (`wrangler deploy`):
   - Uploads worker code to Cloudflare
   - Uploads assets to Workers Assets
   - Site enabled on specified route/domain

## Configuration

### wrangler.toml

The main configuration file is `wrangler.toml` at the project root:

#### Key Settings

- **`main`**: Entry point for the Worker (generated by SvelteKit)
- **`compatibility_date`**: Cloudflare runtime version (change to opt-in to new versions)
- **`compatibility_flags`**:
  - `nodejs_als`: Node.js AsyncLocalStorage support
  - `nodejs_compat`: Node.js API compatibility layer
- **`[assets]`**: Configuration for static asset serving
  - `binding`: Name used to access assets in worker code
  - `directory`: Path to static files
- **`[observability.logs]`**: Logging configuration
- **`[env.production]`**: Production environment configuration
  - `routes`: Routes this worker is linked to
  - `workers_dev`: Enable \*.workers.dev preview URL (for previews)
  - `preview_urls`: Enable versioned preview deployments

### svelte.config.js

Configures SvelteKit to use the Cloudflare adapter:

```javascript
import adapter from '@sveltejs/adapter-cloudflare';

const config = {
  kit: {
    adapter: adapter(),
  },
};
```

The adapter generates Worker-compatible code.

## Deployment Strategy

### Automatic Deployments

The site uses **Cloudflare's GitHub integration** for automatic deployments:

1. **On push to `main` branch**:
   - Deploys to production URL

2. **On pull requests**:
   - Creates a preview deployment
   - Adds comment to PR with preview URL
   - Updates on each commit

### Manual Deployments

**Requirements**:

- `.env.production` file with correct variables
- Sufficient permissions in Cloudflare account

#### Production Deployment

```bash
npm run deploy
```

This builds the site and uses `wrangler` to deploy to Cloudflare Workers.

#### Preview Deployment

```bash
npm run preview
```

The generated preview URL will look like:  
`<VERSION_PREFIX OR ALIAS>-<WORKER_NAME>.<SUBDOMAIN>.workers.dev`

To create a named/aliased preview (useful for feature tracking):

```bash
vite build --mode production
wrangler versions upload -e production --preview-alias feature-name
```

View available versions (also viewable in Cloudflare dash):

```bash
wrangler versions list -e production
```

Cloudflare lets us roll back to any of these listed versions at any point.

## Environment Management

### Environment Files

The project uses different environment files for different contexts:

- **`.env`**: Local development
- **`.env.production`**: Production values

### Relevant Variables

```bash
DEBUG_FLAG_ENABLED=0             # Enable debug features (should be 0 in production)
CLOUDFLARE_ACCOUNT_ID="asdf123"  # Cloudflare account ID (set if you have access to multiple Cloudflare accounts)
```

### Creating Additional Environments

You can create additional environments (e.g., staging) by:

1. **Add environment configuration to `wrangler.toml`**:

   ```toml
   [env.staging]
   routes = [
     { pattern = "staging.acmcsuf.com", custom_domain = true }
   ]
   workers_dev = true
   ```

2. **Create `.env.staging` file** with staging-specific values

3. **Deploy to staging**:
   ```bash
   vite build --mode staging
   wrangler deploy -e staging
   ```

## Additional Resources

- [Cloudflare Workers Documentation](https://developers.cloudflare.com/workers/)
- [SvelteKit Cloudflare Adapter](https://kit.svelte.dev/docs/adapter-cloudflare)
- [Wrangler CLI Reference](https://developers.cloudflare.com/workers/wrangler/)
- [Workers Deployment Guide](https://developers.cloudflare.com/workers/configuration/versions-and-deployments/)
